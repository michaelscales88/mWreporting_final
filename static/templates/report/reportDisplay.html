<!-- Display data used for report -->
{% extends 'dataGrid.html' %}
{%- block styles %}
    {{ super() }}
    <link rel="stylesheet" type="text/css"
          href="{{ url_for('static', filename='css/multiple-select.css') }}">
    <link rel="stylesheet"
          href="{{ bootstrap_find_resource('css/bootstrap-datetimepicker.css', cdn='bootstrapdtp') }}">
    <link rel="stylesheet"
          href="{{ bootstrap_find_resource('css/buttons.dataTables.css', cdn='dataTableBtns', use_minified=true) }}">
{% endblock %}

{% block jumbotron %}
    <div class="row">
        <div class='col-md-6'>
            {% include'report/reportModal.html' %}
            <select id="client-select" title="Clients" multiple="multiple"></select>
            <div>
                <button id="checkAllBtn" class="btn btn-primary">CheckAll</button>
                <button id="uncheckAllBtn" class="btn btn-primary">UncheckAll</button>
            </div>
            <div>
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#dataModal">
                    Change
                </button>
            </div>
        </div>
        <div class='col-md-6'>
            <div class="input-group input-group-lg date">
                <input type="text" id="dtSelectStart" class="form-control" placeholder="Start from..."
                       aria-describedby="sizing-addon1" name="start_time">
                <span class="input-group-addon" id="sizing-addon1">
                    <span class="glyphicon glyphicon-calendar"></span>
                </span>
            </div>
            <div class="input-group input-group-lg date">
                <input type="text" id="dtSelectEnd" class="form-control" placeholder="Go to..."
                       aria-describedby="sizing-addon1" name="end_time">
                <span class="input-group-addon" id="sizing-addon1">
                    <span class="glyphicon glyphicon-calendar"></span>
                </span>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="{{ bootstrap_find_resource('js/bootstrap-datetimepicker.js', cdn='bootstrapdtp', use_minified=true) }}"
            rel="stylesheet"></script>
    <script src="{{ bootstrap_find_resource('js/dataTables.buttons.js', cdn='dataTableBtns', use_minified=true) }}"
            rel="stylesheet"></script>
    <script src="{{ bootstrap_find_resource('js/buttons.flash.js', cdn='dataTableBtns', use_minified=true) }}"
            rel="stylesheet"></script>
    <script src="{{ bootstrap_find_resource('js/buttons.html5.js', cdn='dataTableBtns', use_minified=true) }}"
            rel="stylesheet"></script>
    <script src="{{ bootstrap_find_resource('js/buttons.print.js', cdn='dataTableBtns', use_minified=true) }}"
            rel="stylesheet"></script>
    <script src="{{ bootstrap_find_resource('jszip/3.1.3/jszip.js', cdn='saveJs', use_minified=true) }}"
            rel="stylesheet"></script>
    <script src="{{ bootstrap_find_resource('pdfmake/0.1.32/pdfmake.js', cdn='saveJs', use_minified=true) }}"
            rel="stylesheet"></script>
    <script src="{{ bootstrap_find_resource('pdfmake/0.1.32/vfs_fonts.js', cdn='saveJs') }}"
            rel="stylesheet"></script>
    <script src="{{url_for('static', filename='js/multiple-select.js')}}"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            // configure DateTimePicker
            let dtpConfig = {
                startTime: "{{ start_time }}",
                endTime: "{{ end_time }}"
            };

            // dateTimePicker for dtSelectStart & dtSelectEnd
            $.getScript("{{ url_for('static', filename='js/dtSelector.js') }}", function( data, textStatus, jqxhr ) {
                dtSelector('#dtSelectStart', '#dtSelectEnd', dtpConfig);
            });

            // dateTimePicker for dtLoadStart & dtLoadEnd
            $.getScript("{{ url_for('static', filename='js/dtSelector.js') }}", function( data, textStatus, jqxhr ) {
                dtSelector('#dtLoadStart', '#dtLoadEnd', dtpConfig);
            });

            // configure the modalForm
            $.getScript("{{ url_for('static', filename='js/modalForm.js') }}", function( data, textStatus, jqxhr ) {
                // configure Modal
                let modalConfig = {
                    api: "{{ url_for(api) }}",
                    successTrigger: "button#tableButton",
                    errorCB: "",
                    form: "#dataForm"
                };

                let modalForm = getModalForm(modalConfig);

                $('button#submitButton').on('click', function() {
                    modalForm.submit({action: "load"});
                });
            });

            $( window ).load(function() {
                // Client select box configuration
                let clientSelect = $("#client-select").multipleSelect({
                    width: '100%'
                });
                $("button#checkAllBtn").click(function() {
                    clientSelect.multipleSelect("checkAll");
                });
                $("button#uncheckAllBtn").click(function() {
                    clientSelect.multipleSelect("uncheckAll");
                });
                {#$.ajax({#}
                {#    url: '{{ url_for(client_api) }}',#}
                {#    type: 'GET',#}
                {#    contentType: 'application/x-www-form-urlencoded',#}
                {#    data: {#}
                {#        task: 'get'#}
                {#    },#}
                {#    success: function( data, textStatus, jqxhr ) {#}
                {#        if (textStatus === 'success') {#}
                {#            let options = '';#}
                {#            let clientInfo = data.data;#}
                {#            console.log(clientInfo);#}
                {#            for (let i = 0; i < clientInfo.length; i++) {#}
                {#                options += '<option selected value="' + clientInfo[i][2] + '">' +#}
                {#                            clientInfo[i][1]#}
                {#                            + '</option>';#}
                {#            }#}
                {#            clientSelect.html(options);#}
                {#            clientSelect.multipleSelect("refresh");#}
                {#        }#}
                {##}
                {#    }#}
                {# });#}

                $.getScript("{{ url_for('static', filename='js/dataTable.js') }}", function() {
                    // configure DataTable
                    let tableConfig = {
                        api: "{{ url_for(api) }}",
                        tableName: 'table#displayTable',
                        gridLength: {{ grid_length }}
                    };

                    function getSelectOptions(id){
                        let select = $('#' + id);
                        let obj = [];
                        $('option', select).each(function(){
                            let $this = $(this);
                            obj.push($this.val());
                        });
                        return obj;
                    }

                    function ajaxFn() {
                        return {
                            start_time: $("input#dtSelectStart").val(),
                            end_time: $("input#dtSelectEnd").val(),
                            task: 'sla_report',
                            clients: JSON.stringify(getSelectOptions('client-select'))
                        }
                    }

                    let table = getDataTable(ajaxFn, tableConfig);

                    $('button#tableButton').on('click', function() {
                        table.ajax.reload();
                    });
                });
            });
        });
    </script>
{% endblock %}
